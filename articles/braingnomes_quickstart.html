<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>BrainGnomes Quickstart • BrainGnomes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BrainGnomes Quickstart">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BrainGnomes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7-1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/braingnomes_quickstart.html">BrainGnomes Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/building_containers.html">Building Singularity containers for BrainGnomes</a></li>
    <li><a class="dropdown-item" href="../articles/extract_rois.html">Extracting ROI Timeseries and Connectivity</a></li>
    <li><a class="dropdown-item" href="../articles/postprocessing.html">BrainGnomes Postprocessing Walkthrough</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UNCDEPENdLab/BrainGnomes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>BrainGnomes Quickstart</h1>
                        <h4 data-toc-skip class="author">Michael
Hallquist</h4>
            
            <h4 data-toc-skip class="date">31 Aug 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/UNCDEPENdLab/BrainGnomes/blob/0.7-1/vignettes/braingnomes_quickstart.Rmd" class="external-link"><code>vignettes/braingnomes_quickstart.Rmd</code></a></small>
      <div class="d-none name"><code>braingnomes_quickstart.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>BrainGnomes is an R package that streamlines the preprocessing and
analysis of fMRI data on high-performance computing (HPC) clusters. It
serves as a wrapper around common fMRI processing tools such as
HeuDiConv (for DICOM-to-BIDS conversion), BIDS Validator, MRIQC (quality
control), fMRIPrep (preprocessing pipeline), and ICA-AROMA (automatic
removal of motion artifacts), orchestrating their execution in a
coherent pipeline. The package also provides additional processing steps
for preparing fMRI data for analysis, such as spatial smoothing,
temporal filtering, and confound regression. BrainGnomes uses
containerized software (Singularity images) to ensure reproducible
environments for imaging tools and it manages job submission to HPC
schedulers (SLURM or TORQUE). In this tutorial, we will walk through the
full workflow of setting up and running an fMRI preprocessing study
using BrainGnomes. We will cover the three key functions:</p>
<ul>
<li>setup_project(): Initialize a new study configuration (either from
scratch or from an existing YAML configuration file)</li>
<li>edit_project(): Interactively review and modify the study
configuration by sections</li>
<li>run_project(): Execute the preprocessing pipeline steps on your
dataset, utilizing the HPC environment</li>
</ul>
<p>Along the way, we assume you have the required Singularity container
images for each tool and a working HPC environment. Additional
information about setting up the compute environment is provided in <a href="building_containers.html">BrainGnomes Singularity container
setup</a>. This vignette provides example R code snippets, explains
expected inputs/outputs, and offers troubleshooting tips for common
issues. By the end of demo, a new user should understand how to
configure a study and launch the BrainGnomes pipeline from start to
finish.</p>
<p>This package is designed to run on HPC clusters that use SLURm or
TORQUE. It not designed to run on a standard computer.</p>
<div class="section level3">
<h3 id="basic-process-flow-of-braingnomes">Basic process flow of BrainGnomes<a class="anchor" aria-label="anchor" href="#basic-process-flow-of-braingnomes"></a>
</h3>
<p>BrainGnomes identifies data for all subjects (and sessions) in your
DICOM and BIDS folders, then determines which subjects need to be
processed. It processes data by looping over subjects, submitting jobs
for each subject and processing step to the HPC scheduler. This ensures
that each subject is processed fully (unless a crash occurs).</p>
<div class="float" id="id">
<img src="braingnomes_flow.png" class="class" style="width:70.0%" alt="BrainGnomes flow"><div class="figcaption">BrainGnomes flow</div>
</div>
</div>
<div class="section level3">
<h3 id="running-a-subset-of-subject-or-a-subset-of-processing-steps">Running a subset of subject or a subset of processing steps<a class="anchor" aria-label="anchor" href="#running-a-subset-of-subject-or-a-subset-of-processing-steps"></a>
</h3>
<p>As detailed below, the <code>run_project</code> function submits fMRI
processing jobs to the scheduler. Although BrainGnomes is broadly
intended to run all processing steps and all subjects, you can also run
a subset of subjects. In the intractive mode of
<code>run_project</code>, you can enter a set of subject IDs to run in
case you don’t want to run all of them.</p>
<p>As detailed below, a BrainGnomes project can be configured to only
run some steps (e.g., fmriprep and postprocessing). In this case, you
will only be asked about these steps in <code>run_project</code>. Even
if you have enabled a step, however, you can choose not to run it in
<code>run_project</code>.</p>
<p>For example, if you only wish to run postprocessing stream
“postproc1” on subject 540311, you might respond to the prompts like
this:</p>
<pre><code>Enter subject IDs to process, separated by spaces. Press enter to process all subjects. 

 (Press enter to skip) &gt; 540311

Please select which steps to run:
Run MRIQC? 
 (yes/no) &gt; n
Run fmriprep? 
 (yes/no) &gt; n
Run ICA-AROMA? 
 (yes/no) &gt; n
Run postprocessing? 
 (yes/no) &gt; y
Which postprocessing streams should be run? Press ENTER to select all.

1:   postproc1
2:   rest

Enter one or more numbers separated by spaces and then ENTER, or 0 to cancel
1: 1</code></pre>
<p>You can achieve the same thing by passing in arguments for
<code>steps</code>, <code>postprocess_streams</code>, and
<code>subject_filter</code>, which will schedule the jobs without
prompting you.</p>
<pre><code><span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span>, steps<span class="op">=</span><span class="st">"postprocess"</span>, postprocess_streams<span class="op">=</span><span class="st">"postproc1"</span>, subject_filter<span class="op">=</span><span class="st">"540311"</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="prerequisites-and-setup">Prerequisites and Setup<a class="anchor" aria-label="anchor" href="#prerequisites-and-setup"></a>
</h2>
<p>BrainGnomes is designed to support end-to-end processing of fMRI
data, from original DICOM files to postprocessed data ready for
analysis. That said, you are not required to setup or run any given
step. For example, if you have data that have already be processed up
through fmriprep, you could use BrainGnomes only for postprocessing. In
the setup phase, you will be asked for Singularity containers for all
analysis steps, but many of these can be skipped if you have no
intention of running that step (e.g., MRIQC).</p>
<p>Before using <code>BrainGnomes</code>, attend to the following
prerequisites:</p>
<ol style="list-style-type: decimal">
<li>Installation: Install the BrainGnomes R package. The package is not
on CRAN (yet), so for now, you must install from GitHub. Then load it in
your R session:</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install (if needed) and load BrainGnomes</span></span>
<span><span class="co"># devtools::install_github("UNCDEPENdLab/BrainGnomes")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://uncdependlab.github.io/BrainGnomes/">BrainGnomes</a></span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Working Python installation: During postprocessing, the pipeline
supports masking the data by a brain mask that matches the stereotaxic
space. For example, if your fmriprep data are in MNI152NLin2009cAsym
with a resolution of 2mm, a custom brain mask released with the template
can be applied to the data to remove non-brain voxels. This relies on
TemplateFlow (<a href="http://templateflow.org/" class="external-link uri">http://templateflow.org/</a>), a Python library that
provides a number of templates. For this step to work, you must have a
working Python installation.</li>
<li>HPC Access: Access to an HPC cluster with a job scheduler supported
by BrainGnomes (currently SLURM or TORQUE). You should know which
scheduler your cluster uses.</li>
<li>Singularity: Singularity must be available on the HPC system</li>
<li>You must have downloaded or built the required container image files
for:</li>
</ol>
<ul>
<li>fMRIPrep (e.g., a .sif image of fMRIPrep)</li>
<li>HeuDiConv (container for DICOM to BIDS conversion)</li>
<li>MRIQC (container for MRI quality metrics)</li>
<li>ICA-AROMA (if you plan to use ICA-AROMA for denoising)</li>
<li>BIDS Validator (either a container or an installed binary for the
BIDS validation tool) Make note of the filesystem paths to each of these
container files or executables, as the configuration will require
them.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>Data and Files:</li>
</ol>
<ul>
<li>DICOM files for your study, organized in subject (and optionally
session) folders.</li>
<li>A heuristic file for HeuDiConv (a Python script defining how to
translate DICOM filenames into BIDS format). You or your lab should have
this .py file prepared for your study’s naming conventions.</li>
<li>A FreeSurfer license file (e.g., license.txt or
FreeSurferLicense.txt). fMRIPrep requires a valid FreeSurfer license to
run. You can obtain one for free from the FreeSurfer website. Save the
license file path for the configuration.</li>
<li>Optionally, a TemplateFlow directory if you want to use a
non-default location for TemplateFlow data (standard brain templates).
If unsure, you can specify an empty or new directory and fMRIPrep will
manage downloading templates there.</li>
</ul>
<p>With these in place, we can proceed to create a project
configuration.</p>
</div>
<div class="section level2">
<h2 id="creating-a-project-configuration-with-setup_project">Creating a Project Configuration with
<code>setup_project()</code><a class="anchor" aria-label="anchor" href="#creating-a-project-configuration-with-setup_project"></a>
</h2>
<p>The first step in using <code>BrainGnomes</code> is to create a
project configuration, which is essentially a structured list containing
all the parameters and paths needed for your pipeline. This
configuration can be created interactively using the
<code><a href="../reference/setup_project.html">setup_project()</a></code> function. In typical use, you will call
<code><a href="../reference/setup_project.html">setup_project()</a></code> with no arguments to start a new
configuration from scratch, and it will interactively prompt you for all
required information. The function returns an object with your settings,
and it saves a a YAML configuration file to the root of the project
directory (<code>$metadata$project_directory</code>) called
<code>"project_config.yaml"</code>. If you later</p>
<p>Let’s run <code><a href="../reference/setup_project.html">setup_project()</a></code> to initialize a new project
config:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start an interactive setup for a new fMRI project</span></span>
<span><span class="va">scfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_project.html">setup_project</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This function function will ask a series of questions in the R
console to gather information about your project. Below we outline the
typical prompts and how to respond:</p>
<ul>
<li>Project Name – A short name for your project (used for labeling and
logging). Example: “MyStudy2025”.</li>
<li>Project Directory – The root directory where all project outputs
will be stored. You can provide a path (absolute or relative). If the
directory does not exist, BrainGnomes will offer to create it for you.
For example: “/proj/Longleaf/MyStudy2025” (this will contain subfolders
for BIDS data, fMRIPrep outputs, logs, etc.).</li>
<li>DICOM Directory – The location of your raw DICOM files. This could
be a folder containing subfolders per subject (and session). If it
doesn’t exist, you’ll be prompted to create it as well. For example:
“/proj/Longleaf/MyStudy2025/data_DICOMs”.</li>
<li>TemplateFlow Directory – Path to your TemplateFlow data (standard
templates for fMRIPrep). If you have a central TemplateFlow directory
(e.g., ~/templateflow or a shared path), provide it.</li>
<li>Scratch Directory – A path for temporary scratch space. This is
often on a fast storage (like $TMPDIR or a scratch disk) that is not
intended for long-term storage. If you’re not sure, you can use a
sub-directory in your project directory (e.g.,
“/proj/Longleaf/MyStudy2025/scratch”). Just make sure to keep an eye on
the size of this folder and clean it up periodically if this isn’t done
automatically by your HPC system.</li>
</ul>
<p>You will then be asked whether you want to include major steps in the
pipeline. Each of these can be toggled depending on your intended use.
For example, if you already have fmriprep-processed data and only wish
to apply postprocessing, you wouldn’t need BIDS conversion. For each
major step in the pipeline, you will be asked to specify the following
HPC scheduler settings:</p>
<ul>
<li>The amount of memory needed for the job in GB.</li>
<li>The number of hours needed to complete the job. (Always start a bit
higher than you think you need to avoid killed jobs.)</li>
<li>How many CPU cores should be requested for this job.</li>
<li>Any other command line arguments that will be passed to the command
(e.g., fmriprep)</li>
<li>Any arguments that should be passed to the HPC scheduler (e.g.,
SLURM) beyond what the pipeline already handles itself.</li>
</ul>
<div class="section level3">
<h3 id="flywheel-sync-setup">Flywheel sync setup<a class="anchor" aria-label="anchor" href="#flywheel-sync-setup"></a>
</h3>
<p>If your DICOM data live in a Flywheel project, BrainGnomes can
optionally run a Flywheel-to-filesystem synchronization step before any
downstream processing. This uses the Flywheel CLI (<code>fw sync</code>)
to download DICOMs to your project so that BIDS conversion (and later
steps) operate on a complete, current dataset.</p>
<ul>
<li>Enable in setup: Answer “Run Flywheel sync?” with yes in
<code><a href="../reference/setup_project.html">setup_project()</a></code> (or use <code><a href="../reference/edit_project.html">edit_project()</a></code> →
“Flywheel Sync”). You will be prompted for:
<ul>
<li>Flywheel project URL (<code>source_url</code>), for example:
<code>fw://hallquistm/momentum/</code>. Watch out for the trailing
slash! Flywheel sync operates a lot like rsync, so having the trailing
slash here means, “synchronize files within momentum.”</li>
<li>Drop-off directory for downloaded DICOMs
(<code>metadata/flywheel_sync_directory</code>). This is typically your
project DICOM folder.</li>
<li>Temporary directory for transfers
(<code>metadata/flywheel_temp_directory</code>). Defaults under your
scratch directory.</li>
<li>Whether to save audit logs
(<code>flywheel_sync/save_audit_logs</code>). When enabled, a CSV is
written under your project <code>logs/</code>.</li>
<li>Location of the Flywheel CLI binary
(<code>compute_environment/flywheel</code>), i.e., the path to the
<code>fw</code> executable.</li>
</ul>
</li>
<li>Get an API token: The Flywheel CLI requires an API key associated
with your user. Generate one in the Flywheel web UI:
<ul>
<li>Navigate to your Flywheel site (for example,
<code>https://flywheel.example.edu</code>).</li>
<li>Open your user profile → API Keys and create a key. A direct route
in many deployments is
<code>https://&lt;your-flywheel-host&gt;/#/profile</code> then the API
Keys tab.</li>
<li>Copy the generated token and keep it secure.</li>
</ul>
</li>
<li>Log in with the Flywheel CLI before syncing: BrainGnomes does not
perform <code>fw login</code> for you. You must complete CLI login once
on the machine/account that will run the jobs, e.g.:</li>
</ul>
<pre><code>fw login &lt;YOUR_API_TOKEN&gt;</code></pre>
<p>After successful login, the CLI stores credentials locally so
subsequent runs can use <code>fw sync</code> non-interactively. If
<code>fw login</code> is not complete, the Flywheel sync step will
fail.</p>
<p>What BrainGnomes runs: The sync job uses <code>fw sync</code> with
sensible defaults (includes DICOMs, non-interactive <code>-y</code>,
your specified temp path, and optional audit log). Data are written to
your <code>flywheel_sync_directory</code>. Typically the call will look
something like this:</p>
<pre><code>/path/to/fw sync --include dicom -y --tmp_path &lt;scfg$metadata$flywheel_temp_directory&gt; \
  --save-audit-logs &lt;logs/flywheel_sync_audit.csv&gt; \
  fw://hallquistm/momentum/ \
  /proj/mnhallqlab/studies/momentum/data/fMRI_MRI/raw_images/unc_flywheel_sync</code></pre>
<div class="section level4">
<h4 id="a-note-about-trailing-slashes-in-the-fw-string">A note about trailing slashes in the fw:// string<a class="anchor" aria-label="anchor" href="#a-note-about-trailing-slashes-in-the-fw-string"></a>
</h4>
<p>Flywheel sync operates a lot like rsync, so having the trailing slash
in the <code>fw://</code> project string like
<code>fw://hallquistm/momentum/</code> indicates that folders within
that project are synchronized to the top level of the
flywheel_sync_directory (in the example,
<code>/proj/mnhallqlab/studies/momentum/data/fMRI_MRI/raw_images/unc_flywheel_sync</code>).
Thus, you typically want a trailing slash after your project name in the
<code>fw://</code> string so that the top-level folder itself isn’t
copied to the synch folder.</p>
</div>
<div class="section level4">
<h4 id="deferred-queueing-of-subject-processing-when-flywheel-comes-first">Deferred queueing of subject processing when flywheel comes
first<a class="anchor" aria-label="anchor" href="#deferred-queueing-of-subject-processing-when-flywheel-comes-first"></a>
</h4>
<p>Usage tip: You can include Flywheel sync as part of a larger
unattended run, for example:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span>, steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flywheel_sync"</span>, <span class="st">"bids_conversion"</span>, <span class="st">"fmriprep"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When <code>flywheel_sync</code> is in the requested steps,
BrainGnomes defers subject-level job scheduling until after the sync job
completes. This ensures downstream steps (BIDS conversion, fMRIPrep,
etc.) see all current data from Flywheel.</p>
</div>
</div>
<div class="section level3">
<h3 id="bids-conversion">BIDS conversion<a class="anchor" aria-label="anchor" href="#bids-conversion"></a>
</h3>
<p>You will be prompted for whether you want to include BIDS conversion:
<code>Run BIDS conversion? (yes/no; Press enter to accept default: yes)</code>.
If you say yes, you will be asked for the location of a heudiconv
container, followed by questions about memory, compute hours, CPU cores,
command line arguments, and scheduler arguments.</p>
<p><code>BrainGnomes</code> uses HeuDiConv (<a href="https://github.com/nipy/heudiconv" class="external-link uri">https://github.com/nipy/heudiconv</a>) to convert DICOM
images into BIDS-compatible files and folders. HeuDiConv requires
information on how to identify subjects/sessions in your DICOM folder
and how to convert them. As part of the BIDS conversion setup, you will
be asked to provide:</p>
<ol style="list-style-type: decimal">
<li><p>Subject Regex: A regular expression used to match all subject
directories in the root of your DICOM directory. Consider, for example,
a DICOM directory that includes the following folders:
<code>logs</code>, <code>5300</code>, and <code>5420</code>, where the
numbered directories are the subject IDs. In this case, a good regular
expression for identifying subjects would be, <code>[0-9]+</code> –
matching folders containing numbers. If you want <em>any</em> folder in
the root of your DICOM directory to be considered a subject folder, use
<code>.*</code>.</p></li>
<li><p>(Optional) Session Regex: if you have multi-session data and
these are stored in your DICOM directory as subfolders (i.e., something
like sub-100/ses-1, sub-100/ses-2) you may specify a regular expression
to match session folders inside each subject’s folder. For example, a
session regex of <code>ses-[0-9]+</code> would match any subfolder
starting with <code>ses-</code> followed by one or more numbers. If you
do not have multisession data in this form, leave this blank.</p></li>
<li><p>Subject ID Match Regex: Whereas the Subject Regex specifies what
folders in the root of your DICOM directory should be considered, the
Subject ID Match regular expression specifies how to <em>extract</em>
the ID from the folder name. Use parentheses to denote which part of the
folder name should be preserved as part of the ID. For example, if
folders are named something like <code>sub-&lt;numbers&gt;</code> and
you want to keep the numeric part as the ID, the Subject ID Match Regex
would be, <code>sub-([0-9]+)</code>. If the ID is stored in different
parts of the folder name, you can use more than one set of parentheses,
in which case these will be extracted and pasted together with an
underscore separating each part. For example, consider a folder
<code>subject-16-visit-3</code>. You could extract a subject ID of
<code>16_3</code> using the Regex:
<code>subject-([0-9]+)-visit-([0-9]+)</code>.</p></li>
<li><p>Session Match Regex: This follows the same logic as the Subject
ID Match Regex, but applies to session folders nested within subject
folders. For example, if you have a folder like:
<code>subject-12/ses-1</code>, you would specify
<code>subject-([0-9]+)</code> as your subject ID match regex and
<code>ses-([0-9]+)</code> as your session match regex.</p></li>
<li><p>Heuristic File: Path to the heudiconv heuristic Python script for
your project. For example:
<code>"/proj/Longleaf/MyStudy2025/heuristic.py"</code>. This script
defines the naming scheme for converting DICOMs to BIDS format. Details
for preparing such files can be found here: <a href="https://heudiconv.readthedocs.io/en/latest/heuristics.html" class="external-link uri">https://heudiconv.readthedocs.io/en/latest/heuristics.html</a>.</p></li>
<li><p>Overwrite and Clear Cache: Boolean flags (overwrite and
clear_cache) that determine if heudiconv should overwrite existing
converted data and clear any caching between runs. Usually, you can
accept defaults (FALSE) unless you are re-running conversion and want to
start fresh.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="fmriprep-setup">fmriprep setup<a class="anchor" aria-label="anchor" href="#fmriprep-setup"></a>
</h3>
<p>Next, you will be asked to decide whether to include fmriprep in the
pipeline:
<code>Do you want to include fMRIPrep as part of your preprocessing pipeline? (yes/no; Press enter to accept default: yes)</code>.
If you say yes, you will be asked for the following:</p>
<ol style="list-style-type: decimal">
<li>Location of the fmriprep container</li>
<li>Resource requirements: Defaults for BrainGnomes fmriprep are 48 GB
RAM, 24 hours, and 12 cores</li>
<li>Additional command line arguments to fmriprep. See <a href="https://fmriprep.org/en/stable/usage.html" class="external-link uri">https://fmriprep.org/en/stable/usage.html</a> for
details.</li>
<li>Additional arguments to be passed to the HPC scheduler</li>
<li>Output Spaces: You will choose the standard spaces that fMRIPrep
should output the preprocessed data in. Common choices include MNI
anatomical spaces (e.g., MNI152NLin6Asym), the subject’s T1w native
space, fsaverage (for surface data), etc. The setup_project() function
will present a menu or prompt for selecting these. You can pick multiple
spaces. For example, a typical selection might be MNI152NLin6Asym and
T1w (and if analyzing surface data, possibly fsaverage).</li>
</ol>
<ul>
<li>You will also be asked to provide a ‘resolution index’ for each
template, which governs the spatial resolution of the output image. If
this is omitted, the resolution of the output file will match the voxel
size of the input file. Note that the index is not synonymous with the
voxel size (e.g. ‘2’ may not be 2mm). See <a href="https://fmriprep.org/en/stable/spaces.html#standard-spaces" class="external-link uri">https://fmriprep.org/en/stable/spaces.html#standard-spaces</a>
for details.</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>FreeSurfer License File: You must provide the path to your
FreeSurfer license file so fMRIPrep can run FreeSurfer during
preprocessing.</li>
</ol>
</div>
<div class="section level3">
<h3 id="mriqc-setup">MRIQC setup<a class="anchor" aria-label="anchor" href="#mriqc-setup"></a>
</h3>
<p>Next, you will decide whether to include MRIQC in the pipeline:
<code>Run MRIQC? (yes/no; Press enter to accept default: yes)</code>. If
you say yes, you will be asked for:</p>
<ol style="list-style-type: decimal">
<li>Location of the mriqc container</li>
<li>Resource requirements: Defaults for BrainGnomes mriqc are 32 GB RAM,
12 hours, and 1 core</li>
<li>Additional command line arguments to mriqc. See <a href="https://mriqc.readthedocs.io/en/latest/usage.html#command-line-interface" class="external-link uri">https://mriqc.readthedocs.io/en/latest/usage.html#command-line-interface</a>
for details.</li>
<li>Additional arguments to be passed to the HPC scheduler</li>
</ol>
</div>
<div class="section level3">
<h3 id="ica-aroma-setup">ICA-AROMA setup<a class="anchor" aria-label="anchor" href="#ica-aroma-setup"></a>
</h3>
<p>Next, you will decide whether to include ICA-AROMA in the pipeline:
<code>Run ICA-AROMA? (yes/no; Press enter to accept default: yes)</code>.
If you say yes, you will be asked for:</p>
<ol style="list-style-type: decimal">
<li>Location of the ICA-AROMA container</li>
<li>Resource requirements: Defaults for BrainGnomes mriqc are 32 GB RAM,
36 hours, and 1 core</li>
<li>Additional command line arguments to fmripost_aroma. See <a href="https://fmripost-aroma.readthedocs.io/latest/usage.html#command-line-arguments" class="external-link uri">https://fmripost-aroma.readthedocs.io/latest/usage.html#command-line-arguments</a>
for details.</li>
<li>Additional arguments to be passed to the HPC scheduler</li>
</ol>
<p>(Note: As of fMRIPrep v20.2+, ICA-AROMA is no longer integrated in
fMRIPrep and must be run separately as a BIDS-App called
fmripost-aroma.)</p>
</div>
<div class="section level3">
<h3 id="postprocessing-setup">Postprocessing setup<a class="anchor" aria-label="anchor" href="#postprocessing-setup"></a>
</h3>
<p>Next, will decide whether to include postprocessing in the pipeline:
<code>Do you want to enable postprocessing of the BOLD data?</code>.
Postprocessing includes several optional steps, including</p>
<ul>
<li>Applying a brain mask</li>
<li>Spatial smoothing</li>
<li>Denoising using ICA-AROMA</li>
<li>‘Scrubbing’ of high-motion/high-artifact timepoints</li>
<li>Temporal filtering (e.g., high-pass filtering)</li>
<li>Intensity normalization</li>
<li>Confound calculation and regression</li>
</ul>
<p>If you say ‘yes’ to postprocessing, you will be asked to setup one or
more postprocessing streams for your data. BrainGnomes supports multiple
postprocessing streams, such that the same data can be postprocessed in
multiple ways. For example, you might wish to compare results with
different levels of smoothing or with different temporal filtering
settings.</p>
<p>To specify streams, you will be dropped into a menu system that
lookes like this:</p>
<pre><code>Postprocessing supports multiple streams, allowing you to postprocess data in multiple ways.
Each stream also asks about which files should be postprocessed using the stream. For example,
files with 'rest' in their name could be postprocessed in one way and files with 'nback' could
be processed a different way.

Current postprocessing streams:
  (none defined yet)
Modify postprocessing streams: 

1: Add a stream
2: Edit a stream
3: Delete a stream
4: Show stream settings
5: Finish</code></pre>
<p>For additional details about postprocessing, see (in progress) <a href="postprocessing.html">Postprocessing vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="roi-time-series-extraction-and-functional-connectivity-calculation">ROI time series extraction and functional connectivity
calculation<a class="anchor" aria-label="anchor" href="#roi-time-series-extraction-and-functional-connectivity-calculation"></a>
</h3>
<p>Finally, you will be asked whether to include ROI extraction and
functional connectivity calculation in the pipeline. This step allows
you extract average time series from regions of interest (ROIs) in one
or more atlases/ROI masks. You can also ask BrainGnomes to compute
correlations among the ROI timeseries for functional connectivity
analyses.</p>
<p>The <code><a href="../reference/extract_rois.html">extract_rois()</a></code> function – called using
<code>run_project</code> – loops over configured atlases and writes out
ROI time series and correlation matrices to the project’s
<code>data_rois</code> directory using BIDS-style filenames. For more
details about ROI reduction choices and correlation options, see the <a href="extract_rois.html">Extracting ROIs vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="bids-validation-setup">BIDS validation setup<a class="anchor" aria-label="anchor" href="#bids-validation-setup"></a>
</h3>
<p>As an optional part of the pipeline, bids-validator can be run on the
BIDS directory (once BIDS conversion has completed). This is
accomplished by <code><a href="../reference/run_bids_validation.html">run_bids_validation()</a></code>, which can be run as
needed. Here, saying yes to the prompt
<code>Enable BIDS validation? (yes/no; Press enter to accept default: yes)</code>
will setup the bids-validator step for later use. You will be asked
for:</p>
<ol style="list-style-type: decimal">
<li>Location of the bids-validator program</li>
<li>Resource requirements: Defaults for BrainGnomes bids-validator are
32 GB RAM, 2 hours, and 1 core.</li>
<li>Additional command lines arguments to bids-validator. <a href="https://bids-validator.readthedocs.io/en/stable/user_guide/command-line.html" class="external-link uri">https://bids-validator.readthedocs.io/en/stable/user_guide/command-line.html</a>
for details.</li>
<li>Additional arguments to be passed to the HPC scheduler</li>
</ol>
</div>
<div class="section level3">
<h3 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h3>
<p>After <code>setup_project</code> completes, it will write a file
called <code>project_config.yaml</code> into your project directory (if
one exists, you will be prompted whether to overwrite it). This will
contain all of your settings and can be used in future to load a project
into R from an existing configuration.</p>
</div>
</div>
<div class="section level2">
<h2 id="braingnomes-workflow-in-a-nutshell">BrainGnomes workflow in a nutshell<a class="anchor" aria-label="anchor" href="#braingnomes-workflow-in-a-nutshell"></a>
</h2>
<div class="section level3">
<h3 id="step-1-setup-your-project">Step 1: Setup your project<a class="anchor" aria-label="anchor" href="#step-1-setup-your-project"></a>
</h3>
<p>Use <code><a href="../reference/setup_project.html">setup_project()</a></code> to interactively complete or correct
configuration entries:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_project.html">setup_project</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will say a <code>project_config.yaml</code> file in your project
directory.</p>
</div>
<div class="section level3">
<h3 id="step-2-load-your-configuration">Step 2: Load your configuration<a class="anchor" aria-label="anchor" href="#step-2-load-your-configuration"></a>
</h3>
<p>The step above results in an object in your R workspace called
<code>scfg</code> that contains all of your project settings. This is
great for now, but if you quit R and come back later, you probably want
to pick up from where you left off. You can use
<code><a href="../reference/load_project.html">load_project()</a></code> to load an existing configuration:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_project.html">load_project</a></span><span class="op">(</span><span class="st">"/path/to/my/project"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-edit-configuration">Step 3: Edit configuration<a class="anchor" aria-label="anchor" href="#step-3-edit-configuration"></a>
</h3>
<p>Use <code><a href="../reference/edit_project.html">edit_project()</a></code> for a menu-driven interface to modify
parts of the project configuration.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/edit_project.html">edit_project</a></span><span class="op">(</span><span class="va">scfg</span><span class="op">)</span></span></code></pre></div>
<p>Follow the prompts to choose what to edit. This is useful if you want
to change job resources (e.g., memory or CPU for fMRIPrep) or adjust CLI
options for specific pipeline steps.</p>
</div>
<div class="section level3">
<h3 id="step-4-run-the-project">Step 4: Run the project<a class="anchor" aria-label="anchor" href="#step-4-run-the-project"></a>
</h3>
<p>Once your configuration is complete, you can run the pipeline.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span><span class="op">)</span></span></code></pre></div>
<p>By default, this will prompt you whether to run all steps in your
pipeline. It will also process all available subjects and sessions
defined in the BIDS directory.</p>
<p>If you want to run only a subset of subjects, you can use the
<code>subject_filter</code> argument like:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run subjects 242 and 510 only</span></span>
<span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span>, subject_filter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"242"</span>, <span class="st">"510"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Likewise, if you want to skip the menu prompts for which step to run,
you can use the <code>steps</code> argument. For example, to run only
postprocessing on these subjects:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run subjects 242 and 510 only</span></span>
<span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span>, subject_filter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"242"</span>, <span class="st">"510"</span><span class="op">)</span>, steps<span class="op">=</span><span class="st">"postprocess"</span><span class="op">)</span></span></code></pre></div>
<p>The available <code>steps</code> are
<code>"bids_conversion", "mriqc", "fmriprep", "aroma", "postprocess", "extract_rois"</code>.
Note that if you request a step in <code>run_project</code> that was
never configured it will result in an error.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-braingnomes-on-the-command-line">Running BrainGnomes on the command line<a class="anchor" aria-label="anchor" href="#running-braingnomes-on-the-command-line"></a>
</h2>
<p>As of August 2025, this is a work in progress. That said, there is
basic support for using BrainGnomes on the Linux command line. This is
helpful if you prefer not to start an R session or you just want to
perform basic operations such as editing a study configuration or
running a processing step.</p>
<p>To get BrainGnomes on the command line, you need to add the location
of the package to your Linux path. If you don’t know where it is
installed, run this in an R session.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"BrainGnomes"</span><span class="op">)</span></span></code></pre></div>
<p>You then need this in your path when a terminal starts. If you use
bash, the easiest route is often to add a line like this to your
<code>~/.bashrc</code>.</p>
<pre><code>export PATH="/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/BrainGnomes:$PATH"</code></pre>
<p>This will enable you to type <code>BrainGnomes</code> at the terminal
prompt:</p>
<pre><code>&gt; /BrainGnomes
Usage: BrainGnomes &lt;command&gt; [options]
Commands:
  setup_project [project_name] [project_directory]
  edit_project &lt;project_directory|config.yaml&gt;
  run_project &lt;project_directory|config.yaml&gt; -steps &lt;steps&gt; -subject_filter &lt;ids&gt; -postprocess_streams &lt;streams&gt; [-debug] [-force]</code></pre>
<p>As seen above, the CLI supports <code>setup_project</code>,
<code>edit_project</code>, and <code>run_project</code>. The basics of
these commands have already been described above. On the CLI, the only
difference is that objects such as <code>scfg</code> are not persisted
in a session. Rather, changes are made to the
<code>project_config.yaml</code> script in the project directory.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Hallquist.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
