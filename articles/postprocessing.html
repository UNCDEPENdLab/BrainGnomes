<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>BrainGnomes Postprocessing Walkthrough • BrainGnomes</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BrainGnomes Postprocessing Walkthrough">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BrainGnomes</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/braingnomes_quickstart.html">BrainGnomes Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/building_containers.html">Building Singularity containers for BrainGnomes</a></li>
    <li><a class="dropdown-item" href="../articles/postprocessing.html">BrainGnomes Postprocessing Walkthrough</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UNCDEPENdLab/BrainGnomes/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>BrainGnomes Postprocessing Walkthrough</h1>
                        <h4 data-toc-skip class="author">BrainGnomes
Team</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UNCDEPENdLab/BrainGnomes/blob/main/vignettes/postprocessing.Rmd" class="external-link"><code>vignettes/postprocessing.Rmd</code></a></small>
      <div class="d-none name"><code>postprocessing.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette focuses on the <strong>postprocessing</strong> features
of the <code>BrainGnomes</code> package. Postprocessing refers to the
optional steps that can be applied <em>after</em> fMRIPrep has generated
preprocessed BOLD files. These operations include masking, spatial
smoothing, ICA‑AROMA denoising, scrubbing, temporal filtering, intensity
normalisation and confound handling. Configuration of these steps occurs
via <code><a href="../reference/setup_project.html">setup_project()</a></code> when a project is first created or
later through <code><a href="../reference/edit_project.html">edit_project()</a></code>.</p>
<p>We assume you have created a project configuration object
(<code>scfg</code>) using <code><a href="../reference/setup_project.html">setup_project()</a></code> or loaded one
with <code><a href="../reference/load_project.html">load_project()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://uncdependlab.github.io/BrainGnomes/">BrainGnomes</a></span><span class="op">)</span></span>
<span><span class="co"># scfg &lt;- setup_project()  # or load_project("/path/to/project")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="enabling-postprocessing">Enabling Postprocessing<a class="anchor" aria-label="anchor" href="#enabling-postprocessing"></a>
</h2>
<p>During <code><a href="../reference/setup_project.html">setup_project()</a></code> you will be asked whether to
enable postprocessing for BOLD data. You can toggle this choice later
with <code>edit_project(scfg)</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/edit_project.html">edit_project</a></span><span class="op">(</span><span class="va">scfg</span><span class="op">)</span>  <span class="co"># choose "Postprocessing" from the menu</span></span></code></pre></div>
<p>Once enabled, each step described below can be configured
interactively.</p>
</div>
<div class="section level2">
<h2 id="postprocessing-streams">Postprocessing streams<a class="anchor" aria-label="anchor" href="#postprocessing-streams"></a>
</h2>
<pre><code>Postprocessing supports multiple streams, allowing you to postprocess data in multiple ways.
Each stream also asks about which files should be postprocessed using the stream. For example,
files with 'rest' in their name could be postprocessed in one way and files with 'nback' could
be processed a different way.

Current postprocessing streams:
  (none defined yet)
Modify postprocessing streams: 

1: Add a stream
2: Edit a stream
3: Delete a stream
4: Show stream settings
5: Finish</code></pre>
</div>
<div class="section level2">
<h2 id="global-options">Global Options<a class="anchor" aria-label="anchor" href="#global-options"></a>
</h2>
<p>The first prompts define global postprocessing behavior. You specify
which fMRIPrep outputs to process (<code>input_regex</code>), the BIDS
description for final files (<code>bids_desc</code>), whether to keep
intermediate images, and if existing outputs should be overwritten. The
TR of your scans and an optional brain mask file are also collected.</p>
<div class="section level4">
<h4 id="selecting-bold-files-with-input_regex">Selecting BOLD files with <code>input_regex</code><a class="anchor" aria-label="anchor" href="#selecting-bold-files-with-input_regex"></a>
</h4>
<p>The <code>input_regex</code> setting controls which preprocessed
NIfTI files are included. Instead of writing a full regular expression,
you may supply BIDS entity-value pairs that are converted to a regex at
runtime. For example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>desc<span class="sc">:</span>preproc task<span class="sc">:</span>ridl suffix<span class="sc">:</span>bold</span></code></pre></div>
<p>selects any file containing <code>task-ridl</code> and
<code>desc-preproc</code> with a <code>bold</code> suffix, producing
<code>.*_task-ridl.*_desc-preproc_bold.nii(.gz)?$</code>.</p>
<p>To provide a custom regular expression, prefix it with
<code>regex:</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>regex<span class="sc">:</span> .<span class="sc">*</span>task<span class="sc">-</span>rest.<span class="sc">*</span>preproc.<span class="sc">*</span>\.nii\.gz<span class="sc">$</span></span></code></pre></div>
<p>The prompts in <code>setup_postprocess_globals()</code> provide
additional guidance and examples for constructing these
expressions.【F:R/setup_postprocess.R†L199-L211】</p>
</div>
<div class="section level4">
<h4 id="output-naming-with-bids_desc">Output naming with <code>bids_desc</code><a class="anchor" aria-label="anchor" href="#output-naming-with-bids_desc"></a>
</h4>
<p>The <code>bids_desc</code> value becomes the <code>desc</code> label
of every postprocessed file. If the input filename is</p>
<pre><code>sub-01_task-rest_run-1_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz</code></pre>
<p>and you choose <code>bids_desc = "clean"</code>, the output will be
named</p>
<pre><code>sub-01_task-rest_run-1_space-MNI152NLin2009cAsym_desc-clean_bold.nii.gz</code></pre>
<p>The setup prompt illustrates this behaviour with a similar
example.【F:R/setup_postprocess.R†L215-L221】</p>
</div>
</div>
<div class="section level2">
<h2 id="individual-processing-steps">Individual Processing Steps<a class="anchor" aria-label="anchor" href="#individual-processing-steps"></a>
</h2>
<p>After the global settings, <code><a href="../reference/setup_project.html">setup_project()</a></code> walks through
a sequence of setup functions for each optional step. You may enable or
skip any of them. Below we summarise the purpose of each step, how to
enable it, and key options the setup functions will prompt for.</p>
<div class="section level3">
<h3 id="applying-a-brain-mask">Applying a Brain Mask<a class="anchor" aria-label="anchor" href="#applying-a-brain-mask"></a>
</h3>
<p><code><a href="../reference/setup_apply_mask.html">setup_apply_mask()</a></code> controls whether to apply a binary
brain mask to all BOLD runs. The prompt explains the rationale and lets
you provide a mask file and output prefix.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># excerpt from setup_apply_mask()</span></span></code></pre></div>
<pre><code>Applying a brain mask to your fMRI data ensures that only in-brain voxels are retained during analysis.
This step is optional but often recommended for improving efficiency and accuracy in subsequent processing.
The mask will be applied as a binary filter to the 4D functional data, zeroing out signal outside the brain.
You can specify a custom mask file (in the same space and resolution as your fMRI data), or use the default
mask produced by your preprocessing pipeline.
Do you want to apply a brain mask to your fMRI data?</code></pre>
<p>Options include a path to the mask file (<code>mask_file</code>) and
a prefix for the masked output (<code>prefix</code>, default
<code>"m"</code>).【F:R/setup_postprocess.R†L496-L544】</p>
</div>
<div class="section level3">
<h3 id="spatial-smoothing">Spatial Smoothing<a class="anchor" aria-label="anchor" href="#spatial-smoothing"></a>
</h3>
<p>If you choose to smooth the data, <code><a href="../reference/setup_spatial_smooth.html">setup_spatial_smooth()</a></code>
asks for a Gaussian kernel size in millimetres and a filename prefix.
Smoothing can improve signal-to-noise ratio and alignment across
subjects.</p>
</div>
<div class="section level3">
<h3 id="icaaroma-denoising">ICA‑AROMA Denoising<a class="anchor" aria-label="anchor" href="#icaaroma-denoising"></a>
</h3>
<p>When ICA‑AROMA outputs are available,
<code><a href="../reference/setup_apply_aroma.html">setup_apply_aroma()</a></code> allows you to regress out noise
components. You can opt for nonaggressive (default) or aggressive
removal and set a prefix for the cleaned file. The setup text summarises
the method and provides guidance.【F:R/setup_postprocess.R†L910-L943】
This step mirrors the AROMA-based denoising used in xcp-d, ensuring
consistency with contemporary pipelines.</p>
</div>
<div class="section level3">
<h3 id="scrubbing-highmotion-volumes">Scrubbing High‑Motion Volumes<a class="anchor" aria-label="anchor" href="#scrubbing-highmotion-volumes"></a>
</h3>
<p><code><a href="../reference/setup_scrubbing.html">setup_scrubbing()</a></code> generates spike regressors and
optional censoring of bad time points. The prompts describe how
expressions such as <code>framewise_displacement &gt; 0.9</code> mark
volumes for removal. You may also interpolate over these time points or
drop them from the final NIfTI file. The following lines show part of
the interactive help text.【F:R/setup_postprocess.R†L389-L475】 This
interpolation mirrors the approach used in the xcp-d pipeline, where
censored frames are replaced via cubic splines before further
processing. Filtering and regression then operate on a contiguous time
series, minimising edge artefacts.</p>
</div>
<div class="section level3">
<h3 id="temporal-filtering">Temporal Filtering<a class="anchor" aria-label="anchor" href="#temporal-filtering"></a>
</h3>
<p><code><a href="../reference/setup_temporal_filter.html">setup_temporal_filter()</a></code> configures high‑pass and/or
low‑pass cutoffs and the filtering method (FSL or a Butterworth
implementation). Filtering removes unwanted frequency components such as
slow drifts or fast physiological noise.</p>
<p>The two methods behave slightly differently. The FSL approach calls
<code>fslmaths -bptf</code>, which performs Gaussian weighted high‑ and
low‑pass filtering by specifying the cutoffs in volumes (internally
converted from Hz using a FWHM‑to‑sigma formula). This approach yields
smooth roll‑off around the specified frequencies and minimises ringing
at the expense of a somewhat broad transition band. The Butterworth
option uses a digital IIR filter designed with the <code>signal</code>
package and applied voxelwise via C++ code. Filtering is applied in a
forward and reverse pass to preserve phase. The Butterworth design
allows sharper cutoffs and explicit control of the filter order,
producing a steeper response than the Gaussian implementation. The xcp-d
developers favour Butterworth filtering for its zero-phase design and
sharper transition bands, though the FSL option remains compatible with
many existing workflows.</p>
</div>
<div class="section level3">
<h3 id="intensity-normalisation">Intensity Normalisation<a class="anchor" aria-label="anchor" href="#intensity-normalisation"></a>
</h3>
<p><code><a href="../reference/setup_intensity_normalization.html">setup_intensity_normalization()</a></code> rescales each run so
that the global median intensity matches a user‑specified value (default
10,000). This helps make signal units comparable across subjects.</p>
</div>
<div class="section level3">
<h3 id="confound-calculation-and-regression">Confound Calculation and Regression<a class="anchor" aria-label="anchor" href="#confound-calculation-and-regression"></a>
</h3>
<p>Two steps handle confounds. <code><a href="../reference/setup_confound_calculate.html">setup_confound_calculate()</a></code>
creates a TSV file of nuisance regressors (motion parameters, CompCor
components, DVARS, global signal, etc.) that may be filtered to match
the BOLD data. Columns to include are selected with patterns that can
contain regular expressions or numeric ranges inside angle brackets. For
example <code>a_comp_cor_&lt;1-6&gt;</code> expands to
<code>a_comp_cor_1</code> through <code>a_comp_cor_6</code> and a
pattern like <code>^trans_</code> will match all six motion parameters.
This expansion is implemented in
<code>expand_confound_columns()</code>.【F:R/postprocess_functions.R†L996-L1036】</p>
<p>Standard motion-confound bundles can also be selected using shortcuts
such as <code>"6p"</code>, <code>"12p"</code>, <code>"24p"</code>, or
<code>"36p"</code> to request common sets of motion parameters and their
derivatives/squared terms.</p>
<p>Filtered confounds (listed in <code>columns</code>) undergo the same
temporal filtering as the BOLD data, while unfiltered confounds (listed
in <code>noproc_columns</code>) are appended without processing. Typical
unfiltered regressors include binary spike regressors from
scrubbing.</p>
<p>Confound selection accepts regular expressions and numeric ranges.
For instance <code>^trans_</code> matches all six translational motion
parameters and <code>a_comp_cor_&lt;1-6&gt;</code> expands to the first
six CompCor components. Both filtered and unfiltered sets may use these
patterns, giving fine-grained control over nuisance regressors.</p>
<p><code><a href="../reference/setup_confound_regression.html">setup_confound_regression()</a></code> optionally performs
voxelwise regression of these confounds. If scrubbing is enabled, the
censor file written during <code><a href="../reference/setup_scrubbing.html">setup_scrubbing()</a></code> is passed to
the regression step so that model fits are computed using only volumes
marked as “good.”【F:R/postprocess_functions.R†L748-L764】 The residuals
are written to new NIfTI files with a chosen prefix. Because filtered
confounds match the exact temporal treatment of the BOLD data, this
regression step is safe from mismatch artifacts, similar to the strategy
described in the xcp-d documentation.</p>
</div>
<div class="section level3">
<h3 id="ordering-steps">Ordering Steps<a class="anchor" aria-label="anchor" href="#ordering-steps"></a>
</h3>
<p>Finally, <code>setup_postproc_steps()</code> determines the order in
which enabled steps run. By default the order is masking, smoothing,
AROMA, optional scrubbing/interpolation, temporal filtering, confound
regression, and intensity normalisation. You may override this order by
answering “yes” to the prompt shown in the code
below.【F:R/setup_postprocess.R†L321-L358】</p>
</div>
</div>
<div class="section level2">
<h2 id="running-postprocessing">Running Postprocessing<a class="anchor" aria-label="anchor" href="#running-postprocessing"></a>
</h2>
<p>After configuration, running <code><a href="../reference/run_project.html">run_project()</a></code> will execute
the selected postprocessing steps for each subject.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_project.html">run_project</a></span><span class="op">(</span><span class="va">scfg</span>, steps <span class="op">=</span> <span class="st">"postprocess"</span><span class="op">)</span></span></code></pre></div>
<p>The processing log for each subject is written to the project’s
<code>logs</code> folder, and the final postprocessed NIfTIs receive the
BIDS description specified earlier.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Postprocessing in BrainGnomes is fully configurable. Using
<code><a href="../reference/setup_project.html">setup_project()</a></code> or <code><a href="../reference/edit_project.html">edit_project()</a></code> you can
enable or disable each operation, control parameters such as smoothing
kernel and filtering cutoffs, and decide the order in which steps occur.
Running the project then applies these settings consistently across all
subjects.</p>
<p>For more details on individual functions see the package
documentation and the help pages referenced above.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Hallquist.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
